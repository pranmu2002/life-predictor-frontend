<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Life Predictor â€“ Prediction</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    input, select { margin: 6px 0; padding: 8px; width: 280px; }
    button { margin: 10px 0; padding: 10px 16px; cursor: pointer; }
    .row { display: flex; gap: 24px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; padding: 16px; margin-bottom: 20px; max-width: 340px; }
    .topbar { display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>Prediction Form</h1>
    <div>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <h3>Vitals & Lifestyle</h3>
      <input id="age" type="number" placeholder="Age">
      <input id="bmi" type="number" step="0.1" placeholder="BMI">
      <label>Smoker:</label>
      <select id="smoker"><option value="0">No</option><option value="1">Yes</option></select>
      <input id="stress_level" type="number" placeholder="Stress Level (1-10)">
      <label>Chronic Disease:</label>
      <select id="chronic_disease"><option value="0">No</option><option value="1">Yes</option></select>
      <label>Diabetes:</label>
      <select id="diabetes"><option value="0">No</option><option value="1">Yes</option></select>
      <input id="diet_quality" type="number" placeholder="Diet Quality (1-10)">
    </div>

    <div class="card">
      <h3>Work & Activity</h3>
      <input id="exercise_minutes" type="number" placeholder="Exercise Minutes per Week">
      <input id="work_hours" type="number" placeholder="Work Hours per Week">
      <input id="sleep_hours" type="number" step="0.1" placeholder="Sleep Hours">
      <input id="screen_time" type="number" placeholder="Screen Time (hrs/day)">
      <input id="social_activity" type="number" placeholder="Social Activity (days/week)">
    </div>

    <div class="card">
      <h3>Medical & Environment</h3>
      <input id="income_level" type="number" placeholder="Income Level (1-4)">
      <input id="bp_systolic" type="number" placeholder="BP Systolic">
      <input id="bp_diastolic" type="number" placeholder="BP Diastolic">
      <label>Vaccination Status:</label>
      <select id="vaccination_status"><option value="0">Not up to date</option><option value="1">Up to date</option></select>
      <input id="pollution_index" type="number" placeholder="Pollution Index">
      <input id="alcohol_units" type="number" placeholder="Alcohol Units per Week">
    </div>
  </div>

  <button onclick="submitPrediction()">Submit Prediction</button>

  <div id="result"></div>

  <script>
    const API_BASE = "https://life-predictor.onrender.com";
    const token = localStorage.getItem("token");

    // Guard route
    if (!token) {
      alert("You must login first!");
      window.location.href = "login.html";
    }

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("is_admin");
      window.location.href = "login.html";
    }

    async function submitPrediction() {
      const payload = {
        age: +document.getElementById("age").value,
        bmi: +document.getElementById("bmi").value,
        smoker: +document.getElementById("smoker").value,
        stress_level: +document.getElementById("stress_level").value,
        chronic_disease: +document.getElementById("chronic_disease").value,
        diabetes: +document.getElementById("diabetes").value,
        income_level: +document.getElementById("income_level").value,
        bp_systolic: +document.getElementById("bp_systolic").value,
        bp_diastolic: +document.getElementById("bp_diastolic").value,
        vaccination_status: +document.getElementById("vaccination_status").value,
        pollution_index: +document.getElementById("pollution_index").value,
        sleep_hours: +document.getElementById("sleep_hours").value,
        exercise_minutes: +document.getElementById("exercise_minutes").value,
        alcohol_units: +document.getElementById("alcohol_units").value,
        diet_quality: +document.getElementById("diet_quality").value,
        work_hours: +document.getElementById("work_hours").value,
        screen_time: +document.getElementById("screen_time").value,
        social_activity: +document.getElementById("social_activity").value
      };

      // basic client-side check
      if (Object.values(payload).some(v => Number.isNaN(v))) {
        alert("Please fill in all fields with valid numbers.");
        return;
      }

      const res = await fetch(`${API_BASE}/submit`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert(err.detail || "Failed to submit");
        return;
      }

      const data = await res.json();
      const subId = data.id;

      // Build a Download button that performs an authenticated fetch and downloads the PDF
      document.getElementById("result").innerHTML = `
        <h2>Prediction: ${data.prediction}</h2>
        <button id="dlBtn">Download PDF</button>
      `;

      document.getElementById("dlBtn").onclick = async () => {
        const pdfRes = await fetch(`${API_BASE}/download/${subId}`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        if (!pdfRes.ok) {
          const err = await pdfRes.json().catch(() => ({}));
          alert(err.detail || "Download failed");
          return;
        }
        const blob = await pdfRes.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `submission_${subId}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      };
    }
  </script>
</body>
</html>
